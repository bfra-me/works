---
name: Fro Bot

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  discussion_comment:
    types: [created]
  issues:
    types: [opened, edited]
  pull_request:
    types: [opened, synchronize, reopened]
  schedule:
    - cron: '0 16 * * *'
  workflow_dispatch:
    inputs:
      prompt:
        description: Custom prompt for the Fro Bot agent
        required: true
        default: >-
          Fix failing CI in @bfra.me/create: diagnose logs, apply minimal fixes,
          run pnpm validate, push changes, and summarize the outcome.

permissions:
  contents: read

concurrency:
  group: >-
    fro-bot-${{
      github.event.issue.number ||
      github.event.pull_request.number ||
      github.event.discussion.number ||
      github.run_id
    }}
  cancel-in-progress: false

env:
  PR_REVIEW_PROMPT: |
    You are a skeptical reviewer for a TypeScript monorepo (pnpm workspaces, ESM,
    strict TS). Focus on correctness, safety, and public API stability.

    Scope:
    - Type safety: no `as any`, `@ts-ignore`, or `@ts-expect-error` suppression.
    - Result<T, E> usage instead of throwing for expected errors.
    - Exports: explicit named exports only (no `export *` in application code).
    - Public API: breaking changes to subpath exports, entrypoints, or types.
    - Monorepo integrity: dependency boundaries, build order impact, and
      cross-package version alignment.
    - Tests: new/changed behavior has coverage for happy path, errors, boundaries.
      If tests aren't needed, explain why.
    - Security: no secrets/PII in code, proper input validation.

    Do NOT comment on formatting, lint, or style nits handled by CI.

    Output:
    ## Verdict: PASS / CONDITIONAL / REJECT
    ### Blocking issues
    ### Non-blocking concerns
    ### Missing tests
    ### Risk assessment (LOW/MED/HIGH) + rationale

  SCHEDULE_PROMPT: |
    Perform daily repository autohealing for this TypeScript pnpm monorepo.
    Work through each category in order, making commits and pushing fixes
    directly where possible. Prefer minimal diffs and avoid destructive changes.

    1. ERRORED PRs
       Find open PRs with failing CI checks. For each failing PR:
       a. Check out the PR branch.
       b. Read the failing check logs to diagnose the root cause.
       c. Fix the issue (type errors, lint failures, test regressions, build breaks).
       d. Run `pnpm validate` to confirm the fix passes locally.
       e. Commit with a clear message and push to the PR branch.
       f. Comment on the PR explaining what failed and what was fixed.

    2. SECURITY
       Review Dependabot alerts and open PRs for vulnerable dependencies.
       - If a security update PR exists but has conflicts or check failures,
         fix and push to that PR branch.
       - For unaddressed critical/high advisories with no existing PR, create a
         new PR with the remediation.
       - Do NOT bulk-update unrelated deps in a security PR.

    3. HEALTH & MAINTENANCE
       Check for outdated dependencies across the monorepo:
       - package.json files (root and packages/*): major version bumps.
       - GitHub Actions workflow files (.github/workflows/*.yaml): pin unpinned
         actions to full SHA hashes; update outdated pinned SHAs.
       Create one PR per major dependency bump. Do NOT combine unrelated upgrades.
       Run `pnpm validate` before pushing any upgrade PR.

    4. DEVELOPER EXPERIENCE
       Ensure consistent linting, formatting, and static analysis:
       - Run `pnpm lint` and fix any failures.
       - Run `pnpm type-check` and resolve type errors.
       - Verify ESLint, Prettier, and TypeScript configs are consistent across
         all packages. Fix any drift.
       Commit and push fixes directly to the default branch if they are safe
       (formatting-only or lint auto-fixes). Otherwise, open a PR.

    OUTPUT FORMAT — SINGLE SUMMARY ISSUE
    After completing all work, find an existing open issue titled
    "Daily Autohealing Report — YYYY-MM-DD" (using today's date).
    - If it exists, UPDATE its body with the results below.
    - If it does not exist, CREATE a new issue with that title.

    The issue body MUST use this exact structure:

    ```
    ## Daily Autohealing Report — YYYY-MM-DD

    ### Errored PRs
    | PR  | Failure      | Fix              | Status                           |
    | --- | ------------ | ---------------- | -------------------------------- |
    | #N  | [root cause] | [what was fixed] | ✅ Fixed / ⚠️ Needs human review |

    ### Security
    | Advisory / PR    | Severity             | Action Taken                                 |
    | ---------------- | -------------------- | -------------------------------------------- |
    | [advisory or #N] | Critical/High/Medium | [fix pushed / PR created / skipped — reason] |

    ### Health & Maintenance
    | Dependency | From → To | PR  |
    | ---------- | --------- | --- |
    | [package]  | vX → vY   | #N  |

    ### Developer Experience
    - [list of fixes applied, e.g., "Fixed ESLint drift in packages/es"]

    ### Needs Human Attention
    - [items that could not be auto-fixed, with context]
    ```

    Do NOT create multiple issues. Do NOT comment on individual issues.
    Produce exactly one summary issue per run.

jobs:
  fro-bot:
    name: Fro Bot
    runs-on: ubuntu-latest
    if: >-
      (
        github.event.pull_request == null ||
        (
          !github.event.pull_request.head.repo.fork &&
          !endsWith(github.event.pull_request.user.login || '', '[bot]')
        )
      ) && (
        (
          github.event_name == 'issues' &&
          !endsWith(github.event.issue.user.login || '', '[bot]') &&
          (github.event.issue.user.login || '') != 'fro-bot'
        ) ||
        (
          github.event_name == 'pull_request' &&
          !endsWith(github.event.pull_request.user.login || '', '[bot]') &&
          (github.event.pull_request.user.login || '') != 'fro-bot'
        ) ||
        github.event_name == 'schedule' ||
        github.event_name == 'workflow_dispatch' ||
        (
          (github.event_name == 'issue_comment' ||
           github.event_name == 'pull_request_review_comment' ||
           github.event_name == 'discussion_comment') &&
          contains(github.event.comment.body || '', '@fro-bot') &&
          (github.event.comment.user.login || '') != 'fro-bot' &&
          contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association || '')
        )
      )
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          ref: >-
            ${{
              (github.event.issue.pull_request && format('refs/pull/{0}/head', github.event.issue.number))
              || github.event.pull_request.head.sha
              || ''
            }}
          token: ${{ secrets.FRO_BOT_PAT }}

      - name: Install dependencies
        uses: ./.github/actions/pnpm-install

      - name: Run Fro Bot
        uses: fro-bot/agent@a374fc485acbd20a4fde8486800ff00b79776721 # v0.26.20
        env:
          OPENCODE_PROMPT_ARTIFACT: 'true'
          PROMPT: >-
            ${{
              (github.event_name == 'workflow_dispatch' && (github.event.inputs.prompt || ''))
              || (github.event_name == 'schedule' && env.SCHEDULE_PROMPT)
              || (github.event_name == 'pull_request' && env.PR_REVIEW_PROMPT)
              || ''
            }}
        with:
          github-token: ${{ secrets.FRO_BOT_PAT }}
          auth-json: ${{ secrets.OPENCODE_AUTH_JSON }}
          prompt: ${{ env.PROMPT }}
